<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>智能记账</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
            position: relative;
        }
        
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            padding-bottom: 0;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .login-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #dbeafe 0%, #c7d2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-icon {
            width: 64px;
            height: 64px;
            background: #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        
        h1 {
            font-size: 28px;
            color: #1f2937;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
        }
        
        .input-group {
            position: relative;
            margin-bottom: 20px;
        }
        
        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border 0.3s;
        }
        
        input:focus {
            border-color: #4f46e5;
        }
        
        .input-with-icon {
            padding-right: 50px;
        }
        
        .eye-btn {
            position: absolute;
            right: 12px;
            top: 12px;
            background: none;
            border: none;
            cursor: pointer;
            color: #9ca3af;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338ca;
        }
        
        .btn-green {
            background: #10b981;
            color: white;
        }
        
        .btn-green:hover {
            background: #059669;
        }
        
        .btn-red {
            background: #ef4444;
            color: white;
        }
        
        .btn-red:hover {
            background: #dc2626;
        }
        
        .btn-orange {
            background: #f97316;
            color: white;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 60px 24px 24px 24px;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .content {
            padding: 20px;
            padding-bottom: 90px;
            flex: 1;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 16px;
        }
        
        .asset-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .asset-amount {
            font-size: 36px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .pool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .sub-pool-grid {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 8px;
        }
        
        .sub-pool-grid::-webkit-scrollbar {
            height: 4px;
        }
        
        .sub-pool-grid::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
        
        .pool-card {
            padding: 24px;
            border-radius: 20px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .pool-green {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        }
        
        .pool-blue {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        }
        
        .pool-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .pool-amount {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .pool-subtitle {
            font-size: 12px;
            opacity: 0.75;
        }
        
        .sub-pool-card {
            padding: 16px;
            border-radius: 16px;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 140px;
            flex-shrink: 0;
        }
        
        .sub-pool-vwce {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .sub-pool-cndx {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        }
        
        .sub-pool-btc {
            background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
        }
        
        .sub-pool-spy {
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
        }
        
        .price-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            margin-top: 4px;
        }
        
        .refresh-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .refresh-btn:active {
            transform: scale(0.95);
        }
        
        .sub-pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .sub-pool-name {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .sub-pool-percent {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .sub-pool-amount {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .sub-pool-stats {
            font-size: 10px;
            opacity: 0.85;
            line-height: 1.6;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 16px;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-green {
            background: #d1fae5;
            color: #10b981;
        }
        
        .icon-red {
            background: #fee2e2;
            color: #ef4444;
        }
        
        .icon-orange {
            background: #fed7aa;
            color: #f97316;
        }
        
        .transaction-info {
            flex: 1;
        }
        
        .transaction-desc {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .transaction-date {
            font-size: 12px;
            color: #9ca3af;
        }
        
        .transaction-amount {
            font-weight: bold;
            font-size: 16px;
        }
        
        .amount-green {
            color: #10b981;
        }
        
        .amount-red {
            color: #ef4444;
        }
        
        .amount-orange {
            color: #f97316;
        }
        
        .type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .type-btn {
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .type-btn.active-green {
            background: #10b981;
            color: white;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }
        
        .type-btn.active-red {
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        
        .type-btn.inactive {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .amount-input-wrapper {
            position: relative;
        }
        
        .amount-symbol {
            position: absolute;
            left: 16px;
            top: 16px;
            font-size: 20px;
            color: #9ca3af;
        }
        
        .amount-input {
            padding-left: 40px;
            font-size: 20px;
        }
        
        select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            background: white;
        }
        
        .info-box {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .info-text {
            font-size: 14px;
            color: #1e40af;
            line-height: 1.6;
        }
        
        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .quick-btn {
            padding: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #374151;
        }
        
        .quick-btn:active {
            transform: scale(0.95);
        }
        
        .quick-btn-vwce {
            border-color: #10b981;
            color: #10b981;
        }
        
        .quick-btn-vwce:hover {
            background: #10b981;
            color: white;
        }
        
        .quick-btn-vwce.expense-mode {
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .quick-btn-vwce.expense-mode:hover {
            background: #ef4444;
            color: white;
        }
        
        .quick-btn-cndx {
            border-color: #34d399;
            color: #059669;
        }
        
        .quick-btn-cndx:hover {
            background: #34d399;
            color: white;
        }
        
        .quick-btn-cndx.expense-mode {
            border-color: #f87171;
            color: #dc2626;
        }
        
        .quick-btn-cndx.expense-mode:hover {
            background: #f87171;
            color: white;
        }
        
        .quick-btn-btc {
            border-color: #6ee7b7;
            color: #047857;
        }
        
        .quick-btn-btc:hover {
            background: #6ee7b7;
            color: white;
        }
        
        .quick-btn-btc.expense-mode {
            border-color: #fca5a5;
            color: #b91c1c;
        }
        
        .quick-btn-btc.expense-mode:hover {
            background: #fca5a5;
            color: white;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            padding: 8px 8px 8px 8px;
            gap: 4px;
            z-index: 1000;
        }
        
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
            }
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border: none;
            background: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: #9ca3af;
        }
        
        .nav-btn.active {
            background: #eef2ff;
            color: #4f46e5;
        }
        
        .nav-label {
            font-size: 11px;
            margin-top: 4px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 8px;
            margin-left: 8px;
        }
        
        .delete-btn:hover {
            color: #ef4444;
        }
        
        .transaction-right {
            display: flex;
            align-items: center;
        }
        
        .history-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .history-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .history-left {
            display: flex;
            gap: 12px;
            flex: 1;
        }
        
        .history-details {
            flex: 1;
        }
        
        .history-title {
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .history-meta {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const icons = {
            home: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg>',
            plus: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></svg>',
            minus: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/></svg>',
            history: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>',
            settings: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            eye: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
            eyeOff: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><path d="M1 1l22 22"/></svg>',
            lock: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
            up: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg>',
            down: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 18l-9.5-9.5-5 5L1 6"/><path d="M17 18h6v-6"/></svg>',
            edit: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
            trash: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
            save: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>'
        };
        
        let state = {
            isLoggedIn: false,
            password: '',
            showPassword: false,
            currentPage: 'home',
            storedPassword: '123456',
            developmentPool: 0,
            discretionaryPool: 0,
            vwceStats: { totalIncome: 0, totalExpense: 0, holdings: 0, avgCost: 0 },
            cndxStats: { totalIncome: 0, totalExpense: 0, holdings: 0, avgCost: 0 },
            spyStats: { totalIncome: 0, totalExpense: 0, holdings: 0, avgCost: 0 },
            prices: { vwce: 0, cndx: 0, spy: 0 },
            lastPriceUpdate: null,
            transactions: [],
            recordType: 'income',
            amount: '',
            quantity: '',
            price: '',
            description: '',
            selectedPool: 'discretionary',
            selectedAsset: '',
            newPassword: '',
            confirmPassword: '',
            correctionAmount: '',
            correctionPool: 'development'
        };
        
        function loadData() {
            try {
                const pwd = localStorage.getItem('password');
                if (pwd) state.storedPassword = pwd;

                const dev = localStorage.getItem('developmentPool');
                if (dev) state.developmentPool = parseFloat(dev);

                const disc = localStorage.getItem('discretionaryPool');
                if (disc) state.discretionaryPool = parseFloat(disc);
                
                const vwceStats = localStorage.getItem('vwceStats');
                if (vwceStats) state.vwceStats = JSON.parse(vwceStats);
                
                const cndxStats = localStorage.getItem('cndxStats');
                if (cndxStats) state.cndxStats = JSON.parse(cndxStats);
                
                const spyStats = localStorage.getItem('spyStats');
                if (spyStats) state.spyStats = JSON.parse(spyStats);
                
                const prices = localStorage.getItem('prices');
                if (prices) state.prices = JSON.parse(prices);
                
                const lastUpdate = localStorage.getItem('lastPriceUpdate');
                if (lastUpdate) state.lastPriceUpdate = lastUpdate;

                const tx = localStorage.getItem('transactions');
                if (tx) state.transactions = JSON.parse(tx);
            } catch (error) {
                console.log('初次使用');
            }
        }
        
        function saveData() {
            try {
                localStorage.setItem('password', state.storedPassword);
                localStorage.setItem('developmentPool', state.developmentPool.toString());
                localStorage.setItem('discretionaryPool', state.discretionaryPool.toString());
                localStorage.setItem('vwceStats', JSON.stringify(state.vwceStats));
                localStorage.setItem('cndxStats', JSON.stringify(state.cndxStats));
                localStorage.setItem('spyStats', JSON.stringify(state.spyStats));
                localStorage.setItem('prices', JSON.stringify(state.prices));
                localStorage.setItem('lastPriceUpdate', state.lastPriceUpdate);
                localStorage.setItem('transactions', JSON.stringify(state.transactions));
            } catch (error) {
                console.error('保存失败:', error);
            }
        }
        
        // 获取实时价格 - 使用备用方案
        async function fetchPrices() {
            try {
                // 方案：使用 Yahoo Finance 的查询接口（支持 CORS）
                const symbols = ['VWCE.DE', 'CNDX.L', 'SPY'];
                
                // 使用公开的 API 端点
                const url = `https://query2.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(',')}&fields=regularMarketPrice`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('API 请求失败');
                }
                
                const data = await response.json();
                
                if (data?.quoteResponse?.result) {
                    const quotes = data.quoteResponse.result;
                    
                    quotes.forEach(quote => {
                        if (quote.symbol === 'VWCE.DE' && quote.regularMarketPrice) {
                            state.prices.vwce = quote.regularMarketPrice;
                        } else if (quote.symbol === 'CNDX.L' && quote.regularMarketPrice) {
                            state.prices.cndx = quote.regularMarketPrice;
                        } else if (quote.symbol === 'SPY' && quote.regularMarketPrice) {
                            state.prices.spy = quote.regularMarketPrice;
                        }
                    });
                    
                    state.lastPriceUpdate = new Date().toLocaleString('zh-CN');
                    saveData();
                    render();
                    return;
                }
                
                throw new Error('无法解析价格数据');
            } catch (error) {
                console.error('获取价格失败:', error);
                
                // 提供手动输入价格的选项
                if (confirm('自动获取价格失败。是否手动输入价格？')) {
                    showManualPriceInput();
                }
            }
        }
        
        // 手动输入价格
        function showManualPriceInput() {
            const vwcePrice = prompt('请输入 VWCE 当前价格（欧元）:', state.prices?.vwce || '');
            if (vwcePrice !== null && vwcePrice !== '') {
                state.prices.vwce = parseFloat(vwcePrice);
            }
            
            const cndxPrice = prompt('请输入 CNDX 当前价格（欧元）:', state.prices?.cndx || '');
            if (cndxPrice !== null && cndxPrice !== '') {
                state.prices.cndx = parseFloat(cndxPrice);
            }
            
            const spyPrice = prompt('请输入 S&P 500 (CSP1) 当前价格（欧元）:', state.prices?.spy || '');
            if (spyPrice !== null && spyPrice !== '') {
                state.prices.spy = parseFloat(spyPrice);
            }
            
            if (vwcePrice || cndxPrice || spyPrice) {
                state.lastPriceUpdate = new Date().toLocaleString('zh-CN') + ' (手动)';
                saveData();
                render();
            }
        }
        
        // 自动更新价格（每小时）
        setInterval(() => {
            if (state.isLoggedIn && state.currentPage === 'home') {
                fetchPrices();
            }
        }, 3600000); // 60分钟
        
        function handleLogin() {
            if (state.password === state.storedPassword) {
                state.isLoggedIn = true;
                state.password = '';
                saveData();
                render();
            } else {
                alert('密码错误！');
            }
        }
        
        function handleAddRecord() {
            if (!state.amount || parseFloat(state.amount) <= 0) {
                alert('请输入有效金额');
                return;
            }
            
            const amountNum = parseFloat(state.amount);
            const desc = state.description || (state.recordType === 'income' ? '收入' : '支出');
            
            let assetType = null;
            let quantity = state.quantity ? parseFloat(state.quantity) : 0;
            let price = quantity > 0 ? amountNum / quantity : 0;
            
            if (desc.includes('VWCE')) {
                assetType = 'vwce';
            } else if (desc.includes('CNDX')) {
                assetType = 'cndx';
            } else if (desc.includes('SPY') || desc.includes('S&P')) {
                assetType = 'spy';
            }
            
            const newTx = {
                id: Date.now(),
                type: state.recordType,
                amount: amountNum,
                quantity: quantity,
                price: price,
                description: desc,
                pool: state.recordType === 'income' ? 'auto' : state.selectedPool,
                assetType: assetType,
                date: new Date().toLocaleString('zh-CN')
            };
            
            if (state.recordType === 'income') {
                // 收入只分配到发展金和可支配金，不再自动分配给ETF
                const devAmount = amountNum * 0.9;
                const discAmount = amountNum * 0.1;
                state.developmentPool += devAmount;
                state.discretionaryPool += discAmount;
                
                // 如果是卖出资产，更新持仓
                if (assetType === 'vwce') {
                    state.vwceStats.totalIncome += amountNum;
                    state.vwceStats.holdings -= quantity;
                    if (state.vwceStats.holdings < 0) state.vwceStats.holdings = 0;
                } else if (assetType === 'cndx') {
                    state.cndxStats.totalIncome += amountNum;
                    state.cndxStats.holdings -= quantity;
                    if (state.cndxStats.holdings < 0) state.cndxStats.holdings = 0;
                } else if (assetType === 'spy') {
                    state.spyStats.totalIncome += amountNum;
                    state.spyStats.holdings -= quantity;
                    if (state.spyStats.holdings < 0) state.spyStats.holdings = 0;
                }
            } else {
                // 支出
                if (state.selectedPool === 'development') {
                    if (state.developmentPool >= amountNum) {
                        state.developmentPool -= amountNum;
                        
                        // 买入资产时更新持仓和成本
                        if (assetType === 'vwce') {
                            // 只扣除发展金，不扣除 vwcePool
                            state.vwceStats.totalExpense += amountNum;
                            
                            // 计算新的平均成本
                            const oldTotalCost = state.vwceStats.avgCost * state.vwceStats.holdings;
                            state.vwceStats.holdings += quantity;
                            state.vwceStats.avgCost = (oldTotalCost + amountNum) / state.vwceStats.holdings;
                            
                        } else if (assetType === 'cndx') {
                            state.cndxStats.totalExpense += amountNum;
                            
                            const oldTotalCost = state.cndxStats.avgCost * state.cndxStats.holdings;
                            state.cndxStats.holdings += quantity;
                            state.cndxStats.avgCost = (oldTotalCost + amountNum) / state.cndxStats.holdings;
                            
                        } else if (assetType === 'spy') {
                            state.spyStats.totalExpense += amountNum;
                            
                            const oldTotalCost = state.spyStats.avgCost * state.spyStats.holdings;
                            state.spyStats.holdings += quantity;
                            state.spyStats.avgCost = (oldTotalCost + amountNum) / state.spyStats.holdings;
                        }
                    } else {
                        alert('发展金余额不足！');
                        return;
                    }
                } else {
                    if (state.discretionaryPool >= amountNum) {
                        state.discretionaryPool -= amountNum;
                    } else {
                        alert('可支配金余额不足！');
                        return;
                    }
                }
            }
            
            state.transactions.unshift(newTx);
            state.amount = '';
            state.quantity = '';
            state.price = '';
            state.description = '';
            state.currentPage = 'home';
            saveData();
            render();
        }
        
        function handleCorrection() {
            if (!state.correctionAmount) {
                alert('请输入修正金额');
                return;
            }
            
            const amountNum = parseFloat(state.correctionAmount);
            const newTx = {
                id: Date.now(),
                type: 'correction',
                amount: amountNum,
                description: '资产修正',
                pool: state.correctionPool,
                date: new Date().toLocaleString('zh-CN')
            };
            
            if (state.correctionPool === 'development') {
                state.developmentPool = amountNum;
            } else {
                state.discretionaryPool = amountNum;
            }
            
            state.transactions.unshift(newTx);
            state.correctionAmount = '';
            saveData();
            render();
            alert('资产修正成功！');
        }
        
        function deleteTransaction(id) {
            if (confirm('确定要删除这条记录吗？')) {
                state.transactions = state.transactions.filter(t => t.id !== id);
                saveData();
                render();
            }
        }
        
        function handleChangePassword() {
            if (!state.newPassword || !state.confirmPassword) {
                alert('请输入新密码');
                return;
            }
            if (state.newPassword !== state.confirmPassword) {
                alert('两次密码不一致');
                return;
            }
            state.storedPassword = state.newPassword;
            state.newPassword = '';
            state.confirmPassword = '';
            saveData();
            render();
            alert('密码修改成功！');
        }
        
        function handleLogout() {
            if (confirm('确定要退出登录吗？')) {
                state.isLoggedIn = false;
                state.currentPage = 'home';
                render();
            }
        }
        
        function render() {
            try {
                const root = document.getElementById('root');
                
                if (!state.isLoggedIn) {
                    root.innerHTML = `
                        <div class="login-page">
                            <div class="login-card">
                                <div class="login-icon">${icons.lock}</div>
                                <h1>智能记账</h1>
                                <p class="subtitle">请输入密码登录</p>
                                <div class="input-group">
                                    <input 
                                        type="${state.showPassword ? 'text' : 'password'}" 
                                        id="passwordInput"
                                        placeholder="请输入密码"
                                        class="input-with-icon"
                                        value="${state.password || ''}"
                                    />
                                    <button class="eye-btn" onclick="togglePassword()">
                                        ${state.showPassword ? icons.eyeOff : icons.eye}
                                    </button>
                                </div>
                                <button class="btn btn-primary" onclick="handleLogin()">登录</button>
                                <p style="text-align:center;color:#9ca3af;font-size:14px;margin-top:20px;">
                                    默认密码: 123456
                                </p>
                            </div>
                        </div>
                    `;
                    
                    const pwdInput = document.getElementById('passwordInput');
                    if (pwdInput) {
                        pwdInput.addEventListener('input', (e) => {
                            state.password = e.target.value;
                        });
                        
                        pwdInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') handleLogin();
                        });
                    }
                    
                    return;
                }
                
                // 确保所有必需的数据结构存在
                if (!state.vwceStats) state.vwceStats = { totalIncome: 0, totalExpense: 0, holdings: 0, avgCost: 0 };
                if (!state.cndxStats) state.cndxStats = { totalIncome: 0, totalExpense: 0, holdings: 0, avgCost: 0 };
                if (!state.spyStats) state.spyStats = { totalIncome: 0, totalExpense: 0, holdings: 0, avgCost: 0 };
                if (!state.prices) state.prices = { vwce: 0, cndx: 0, spy: 0 };
                if (!state.transactions) state.transactions = [];
                
                const totalAssets = (state.developmentPool || 0) + (state.discretionaryPool || 0);
            
                // 计算盈亏 - 添加安全检查
                const vwceHoldings = (state.vwceStats && typeof state.vwceStats.holdings === 'number') ? state.vwceStats.holdings : 0;
                const vwceAvgCost = (state.vwceStats && typeof state.vwceStats.avgCost === 'number') ? state.vwceStats.avgCost : 0;
                const vwcePrice = (state.prices && typeof state.prices.vwce === 'number') ? state.prices.vwce : 0;
                const vwceMarketValue = vwceHoldings * vwcePrice;
                const vwcePL = vwceMarketValue - vwceAvgCost * vwceHoldings;
                const vwcePLPercent = (vwceAvgCost * vwceHoldings) > 0 ? (vwcePL / (vwceAvgCost * vwceHoldings)) * 100 : 0;
                
                const cndxHoldings = (state.cndxStats && typeof state.cndxStats.holdings === 'number') ? state.cndxStats.holdings : 0;
                const cndxAvgCost = (state.cndxStats && typeof state.cndxStats.avgCost === 'number') ? state.cndxStats.avgCost : 0;
                const cndxPrice = (state.prices && typeof state.prices.cndx === 'number') ? state.prices.cndx : 0;
                const cndxMarketValue = cndxHoldings * cndxPrice;
                const cndxPL = cndxMarketValue - cndxAvgCost * cndxHoldings;
                const cndxPLPercent = (cndxAvgCost * cndxHoldings) > 0 ? (cndxPL / (cndxAvgCost * cndxHoldings)) * 100 : 0;
                
                const spyHoldings = (state.spyStats && typeof state.spyStats.holdings === 'number') ? state.spyStats.holdings : 0;
                const spyAvgCost = (state.spyStats && typeof state.spyStats.avgCost === 'number') ? state.spyStats.avgCost : 0;
                const spyPrice = (state.prices && typeof state.prices.spy === 'number') ? state.prices.spy : 0;
                const spyMarketValue = spyHoldings * spyPrice;
                const spyPL = spyMarketValue - spyAvgCost * spyHoldings;
                const spyPLPercent = (spyAvgCost * spyHoldings) > 0 ? (spyPL / (spyAvgCost * spyHoldings)) * 100 : 0;
                
                // 计算总投资（基于成本）
                const totalInvestment = (vwceAvgCost * vwceHoldings) + (cndxAvgCost * cndxHoldings) + (spyAvgCost * spyHoldings);
                
                let content = '';
                
                if (state.currentPage === 'home') {
                    content = `
                        <div class="card">
                            <div class="asset-card">
                                <span style="color:#6b7280;">总资产</span>
                            </div>
                            <div class="asset-amount">€${(totalAssets || 0).toFixed(2)}</div>
                        </div>
                        
                        <div class="pool-grid">
                            <div class="pool-card pool-green">
                                <div class="pool-title">发展金</div>
                                <div class="pool-amount">€${(state.developmentPool || 0).toFixed(2)}</div>
                                <div class="pool-subtitle">90%收入</div>
                            </div>
                            
                            <div class="pool-card pool-blue">
                                <div class="pool-title">可支配金</div>
                                <div class="pool-amount">€${(state.discretionaryPool || 0).toFixed(2)}</div>
                                <div class="pool-subtitle">10%收入</div>
                            </div>
                        </div>
                        
                        <div class="card" style="position:relative;">
                            <button class="refresh-btn" onclick="event.preventDefault(); event.stopPropagation(); fetchPrices();" title="自动获取价格">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                                </svg>
                            </button>
                            <button class="refresh-btn" onclick="event.preventDefault(); event.stopPropagation(); showManualPriceInput();" title="手动输入价格" style="right:60px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <h3 class="card-title">发展金资产分布</h3>
                            ${state.lastPriceUpdate ? `<p style="font-size:12px;color:#9ca3af;margin-bottom:12px;">最后更新: ${state.lastPriceUpdate}</p>` : ''}
                            <div class="sub-pool-grid">
                                <div class="sub-pool-card sub-pool-vwce">
                                    <div class="sub-pool-header">
                                        <div class="sub-pool-name">VWCE</div>
                                    </div>
                                    <div class="sub-pool-amount">€${(vwceAvgCost * vwceHoldings).toFixed(2)}</div>
                                    ${vwcePrice > 0 ? `<div class="price-badge">€${vwcePrice.toFixed(2)}/股</div>` : ''}
                                    <div class="sub-pool-stats">
                                        持仓: ${vwceHoldings.toFixed(2)} 股<br/>
                                        成本: €${vwceAvgCost.toFixed(2)}/股<br/>
                                        ${vwcePrice > 0 ? `
                                            市值: €${vwceMarketValue.toFixed(2)}<br/>
                                            盈亏: €${vwcePL.toFixed(2)} (${vwcePLPercent > 0 ? '+' : ''}${vwcePLPercent.toFixed(2)}%)
                                        ` : `收支: €${((state.vwceStats?.totalIncome || 0) - (state.vwceStats?.totalExpense || 0)).toFixed(2)}`}
                                    </div>
                                </div>
                                <div class="sub-pool-card sub-pool-cndx">
                                    <div class="sub-pool-header">
                                        <div class="sub-pool-name">CNDX</div>                                        
                                    </div>
                                    <div class="sub-pool-amount">€${(cndxAvgCost * cndxHoldings).toFixed(2)}</div>
                                    ${cndxPrice > 0 ? `<div class="price-badge">€${cndxPrice.toFixed(2)}/股</div>` : ''}
                                    <div class="sub-pool-stats">
                                        持仓: ${cndxHoldings.toFixed(2)} 股<br/>
                                        成本: €${cndxAvgCost.toFixed(2)}/股<br/>
                                        ${cndxPrice > 0 ? `
                                            市值: €${cndxMarketValue.toFixed(2)}<br/>
                                            盈亏: €${cndxPL.toFixed(2)} (${cndxPLPercent > 0 ? '+' : ''}${cndxPLPercent.toFixed(2)}%)
                                        ` : `收支: €${((state.cndxStats?.totalIncome || 0) - (state.cndxStats?.totalExpense || 0)).toFixed(2)}`}
                                    </div>
                                </div>
                                <div class="sub-pool-card sub-pool-spy">
                                    <div class="sub-pool-header">
                                        <div class="sub-pool-name">SPY</div>
                                    </div>
                                    <div class="sub-pool-amount">€${(spyAvgCost * spyHoldings).toFixed(2)}</div>
                                    ${spyPrice > 0 ? `<div class="price-badge">${spyPrice.toFixed(2)}/股</div>` : ''}
                                    <div class="sub-pool-stats">
                                        持仓: ${spyHoldings.toFixed(2)} 股<br/>
                                        成本: €${spyAvgCost.toFixed(2)}/股<br/>
                                        ${spyPrice > 0 ? `
                                            市值: €${spyMarketValue.toFixed(2)}<br/>
                                            盈亏: €${spyPL.toFixed(2)} (${spyPLPercent > 0 ? '+' : ''}${spyPLPercent.toFixed(2)}%)
                                        ` : '收支: €' + ((state.spyStats.totalIncome - state.spyStats.totalExpense).toFixed(2))}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align:center;color:#6b7280;font-size:13px;padding-top:12px;border-top:1px solid #e5e7eb;margin-top:8px;">
                                总投资: €${totalInvestment.toFixed(2)} | 现金余额: €${(state.developmentPool - totalInvestment).toFixed(2)}
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title">最近交易</h3>
                            ${(state.transactions && state.transactions.length > 0) ? 
                                state.transactions.slice(0, 5).map(tx => `
                                    <div class="transaction-item">
                                        <div class="transaction-left">
                                            <div class="transaction-icon icon-${tx.type === 'income' ? 'green' : tx.type === 'correction' ? 'orange' : 'red'}">
                                                ${tx.type === 'income' ? icons.up : tx.type === 'correction' ? icons.edit : icons.down}
                                            </div>
                                            <div class="transaction-info">
                                                <div class="transaction-desc">${tx.description || ''}</div>
                                                <div class="transaction-date">${tx.date || ''}</div>
                                            </div>
                                        </div>
                                        <div class="transaction-amount amount-${tx.type === 'income' ? 'green' : tx.type === 'correction' ? 'orange' : 'red'}">
                                            ${tx.type === 'income' ? '+' : tx.type === 'correction' ? '=' : '-'}€${(tx.amount || 0).toFixed(2)}
                                        </div>
                                    </div>
                                `).join('') : 
                                '<p class="empty-state">暂无交易记录</p>'
                            }
                        </div>
                    `;
                } else if (state.currentPage === 'add') {
                    content = `
                        <div class="card">
                            <div class="type-selector">
                                <button 
                                    class="type-btn ${state.recordType === 'income' ? 'active-green' : 'inactive'}"
                                    onclick="setRecordType('income')"
                                >收入</button>
                                <button 
                                    class="type-btn ${state.recordType === 'expense' ? 'active-red' : 'inactive'}"
                                    onclick="setRecordType('expense')"
                                >支出</button>
                            </div>
                            
                            <div style="margin-bottom:16px;">
                                <label class="label">快捷操作</label>
                                <div class="quick-buttons">
                                    <button class="quick-btn quick-btn-vwce ${state.recordType === 'expense' ? 'expense-mode' : ''}" onclick="fillQuick('VWCE')">
                                        ${state.recordType === 'income' ? '卖出' : '买入'} VWCE
                                    </button>
                                    <button class="quick-btn quick-btn-cndx ${state.recordType === 'expense' ? 'expense-mode' : ''}" onclick="fillQuick('CNDX')">
                                        ${state.recordType === 'income' ? '卖出' : '买入'} CNDX
                                    </button>
                                    <button class="quick-btn quick-btn-btc ${state.recordType === 'expense' ? 'expense-mode' : ''}" onclick="fillQuick('S&P 500')">
                                        ${state.recordType === 'income' ? '卖出' : '买入'} S&P 500
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom:20px;">
                                <label class="label">数量（股数）</label>
                                <input 
                                    type="number" 
                                    id="quantityInput"
                                    placeholder="0"
                                    value="${state.quantity || ''}"
                                    step="0.01"
                                />
                            </div>
                            
                            <div style="margin-bottom:20px;">
                                <label class="label">金额</label>
                                <div class="amount-input-wrapper">
                                    <span class="amount-symbol">€</span>
                                    <input 
                                        type="number" 
                                        id="amountInput"
                                        class="amount-input"
                                        placeholder="0.00"
                                        value="${state.amount || ''}"
                                    />
                                </div>
                            </div>
                            
                            <div style="margin-bottom:20px;">
                                <label class="label">描述</label>
                                <input 
                                    type="text" 
                                    id="descInput"
                                    placeholder="${state.recordType === 'income' ? '收入来源' : '支出用途'}"
                                    value="${state.description || ''}"
                                />
                            </div>
                            
                            ${state.recordType === 'expense' ? `
                                <div style="margin-bottom:20px;">
                                    <label class="label">使用资金池</label>
                                    <select id="poolSelect" onchange="updateSelectedPool(this.value)">
                                        <option value="discretionary" ${state.selectedPool === 'discretionary' ? 'selected' : ''}>
                                            可支配金 (€${state.discretionaryPool.toFixed(2)})
                                        </option>
                                        <option value="development" ${state.selectedPool === 'development' ? 'selected' : ''}>
                                            发展金 (€${state.developmentPool.toFixed(2)})
                                        </option>
                                    </select>
                                </div>
                            ` : ''}
                            
                            ${state.recordType === 'income' ? `
                                <div class="info-box">
                                    <p class="info-text">
                                        💡 收入将自动分配：<br/>
                                        • 90% → 发展金<br/>
                                        • 10% → 可支配金
                                    </p>
                                </div>
                            ` : ''}
                            
                            <button 
                                class="btn ${state.recordType === 'income' ? 'btn-green' : 'btn-red'}"
                                onclick="handleAddRecord()"
                            >
                                添加${state.recordType === 'income' ? '收入' : '支出'}
                            </button>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        const quantityInput = document.getElementById('quantityInput');
                        const amountInput = document.getElementById('amountInput');
                        const descInput = document.getElementById('descInput');
                        
                        if (quantityInput) {
                            quantityInput.addEventListener('input', (e) => {
                                state.quantity = e.target.value;
                            });
                        }
                        
                        if (amountInput) {
                            amountInput.addEventListener('input', (e) => {
                                state.amount = e.target.value;
                            });
                        }
                        
                        if (descInput) {
                            descInput.addEventListener('input', (e) => {
                                state.description = e.target.value;
                            });
                        }
                    }, 0);
                } else if (state.currentPage === 'history') {
                    content = (state.transactions && state.transactions.length > 0) ? 
                        state.transactions.map(tx => `
                            <div class="history-card">
                                <div class="history-content">
                                    <div class="history-left">
                                        <div class="transaction-icon icon-${tx.type === 'income' ? 'green' : tx.type === 'correction' ? 'orange' : 'red'}">
                                            ${tx.type === 'income' ? icons.up : tx.type === 'correction' ? icons.edit : icons.down}
                                        </div>
                                        <div class="history-details">
                                            <div class="history-title">${tx.description || ''}</div>
                                            <div class="transaction-date">${tx.date || ''}</div>
                                            <div class="history-meta">
                                                ${tx.type === 'income' ? '自动分配' : 
                                                  tx.type === 'expense' ? (tx.pool === 'development' ? '发展金' : '可支配金') :
                                                  (tx.pool === 'development' ? '发展金修正' : '可支配金修正')}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="transaction-right">
                                        <div class="transaction-amount amount-${tx.type === 'income' ? 'green' : tx.type === 'correction' ? 'orange' : 'red'}">
                                            ${tx.type === 'income' ? '+' : tx.type === 'correction' ? '=' : '-'}€${(tx.amount || 0).toFixed(2)}
                                        </div>
                                        <button class="delete-btn" onclick="deleteTransaction(${tx.id})">
                                            ${icons.trash}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('') :
                        '<div class="empty-state">' + icons.history + '<p style="margin-top:16px;">暂无交易记录</p></div>';
                } else if (state.currentPage === 'settings') {
                    content = `
                        <div class="card">
                            <h3 class="card-title">资产修正</h3>
                            <div style="margin-bottom:12px;">
                                <select id="correctionPool" onchange="updateCorrectionPool(this.value)">
                                    <option value="development" ${state.correctionPool === 'development' ? 'selected' : ''}>发展金</option>
                                    <option value="discretionary" ${state.correctionPool === 'discretionary' ? 'selected' : ''}>可支配金</option>
                                </select>
                            </div>
                            <div style="margin-bottom:12px;">
                                <input 
                                    type="number" 
                                    id="correctionAmount"
                                    placeholder="输入修正后的金额"
                                    value="${state.correctionAmount || ''}"
                                />
                            </div>
                            <button class="btn btn-orange" onclick="handleCorrection()">执行修正</button>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title">修改密码</h3>
                            <div style="margin-bottom:12px;">
                                <input 
                                    type="password" 
                                    id="newPwdInput"
                                    placeholder="输入新密码"
                                    value="${state.newPassword || ''}"
                                />
                            </div>
                            <div style="margin-bottom:12px;">
                                <input 
                                    type="password" 
                                    id="confirmPwdInput"
                                    placeholder="确认新密码"
                                    value="${state.confirmPassword || ''}"
                                />
                            </div>
                            <button class="btn btn-primary" onclick="handleChangePassword()">
                                <span style="display:inline-flex;align-items:center;gap:8px;">
                                    ${icons.save}
                                    <span>保存密码</span>
                                </span>
                            </button>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title">关于</h3>
                            <p style="color:#6b7280;font-size:14px;line-height:1.8;">
                                • 版本: 1.0.0<br/>
                                • 数据自动保存<br/>
                                • 收入自动分配：发展金90%，可支配金10%
                            </p>
                        </div>
                        
                        <button class="btn btn-red" onclick="handleLogout()">退出登录</button>
                    `;
                    
                    setTimeout(() => {
                        const corrAmountInput = document.getElementById('correctionAmount');
                        if (corrAmountInput) {
                            corrAmountInput.addEventListener('input', (e) => {
                                state.correctionAmount = e.target.value;
                            });
                        }
                        
                        const newPwdInput = document.getElementById('newPwdInput');
                        const confirmPwdInput = document.getElementById('confirmPwdInput');
                        
                        if (newPwdInput) {
                            newPwdInput.addEventListener('input', (e) => {
                                state.newPassword = e.target.value;
                            });
                        }
                        
                        if (confirmPwdInput) {
                            confirmPwdInput.addEventListener('input', (e) => {
                                state.confirmPassword = e.target.value;
                            });
                        }
                    }, 0);
                }
                
                root.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1 style="font-size:24px;margin:0;">
                                ${state.currentPage === 'home' ? '资产总览' :
                                  state.currentPage === 'add' ? (state.recordType === 'income' ? '添加收入' : '添加支出') :
                                  state.currentPage === 'history' ? '交易历史' : '设置'}
                            </h1>
                        </div>
                        <div class="content">
                            ${content}
                        </div>
                        <div class="bottom-nav">
                            <button class="nav-btn ${state.currentPage === 'add' && state.recordType === 'income' ? 'active' : ''}" onclick="setPage('add'); setRecordType('income');">
                                ${icons.plus}
                                <span class="nav-label">收入</span>
                            </button>
                            <button class="nav-btn ${state.currentPage === 'add' && state.recordType === 'expense' ? 'active' : ''}" onclick="quickExpense()">
                                ${icons.minus}
                                <span class="nav-label">支出</span>
                            </button>
                            <button class="nav-btn ${state.currentPage === 'home' ? 'active' : ''}" onclick="setPage('home')">
                                ${icons.home}
                                <span class="nav-label">首页</span>
                            </button>
                            <button class="nav-btn ${state.currentPage === 'history' ? 'active' : ''}" onclick="setPage('history')">
                                ${icons.history}
                                <span class="nav-label">历史</span>
                            </button>
                            <button class="nav-btn ${state.currentPage === 'settings' ? 'active' : ''}" onclick="setPage('settings')">
                                ${icons.settings}
                                <span class="nav-label">设置</span>
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('渲染错误:', error);
                console.error('错误堆栈:', error.stack);
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div style="padding:40px;text-align:center;">
                        <h2 style="color:#ef4444;">渲染出错</h2>
                        <p style="color:#6b7280;margin:20px 0;">${error.message}</p>
                        <button onclick="location.reload()" style="padding:12px 24px;background:#4f46e5;color:white;border:none;border-radius:8px;cursor:pointer;">
                            刷新页面
                        </button>
                        <pre style="text-align:left;background:#f3f4f6;padding:20px;margin-top:20px;overflow:auto;">${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        function togglePassword() {
            state.showPassword = !state.showPassword;
            render();
        }
        
        function setPage(page) {
            state.currentPage = page;
            render();
        }
        
        function setRecordType(type) {
            state.recordType = type;
            render();
        }
        
        function updateSelectedPool(pool) {
            state.selectedPool = pool;
        }
        
        function updateCorrectionPool(pool) {
            state.correctionPool = pool;
        }
        
        function quickExpense() {
            state.recordType = 'expense';
            state.currentPage = 'add';
            render();
        }
        
        function fillQuick(asset) {
            const action = state.recordType === 'income' ? '卖出' : '买入';
            state.description = `${action} ${asset}`;
            render();
            setTimeout(() => {
                const amountInput = document.getElementById('amountInput');
                if (amountInput) amountInput.focus();
            }, 100);
        }
        
        loadData();
        render();
        
        // 登录后首次获取价格
        if (state.isLoggedIn && !state.lastPriceUpdate) {
            fetchPrices();
        }
    </script>
</body>
</html>
